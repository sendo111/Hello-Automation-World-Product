version: 2.0
jobs:
  build:
    machine:
      # Ubuntu v14.04
      # https://circleci.com/docs/ja/2.0/configuration-reference/
      image: circleci/classic:edge
    steps:
      - run:
          name: docker-compose up
          command: sleep 5
          # command: docker-compose ip -d
      - run:
          name: sleep 10 seconds
          command: sleep 10
      - run:
          name: execute django makemigrations
          command: sleep 5
          # command: docker-compose run haw ./manage.py makemigrations
      - run:
          name: execute django migrate
          command: sleep 5
          # command: docker-compose run haw ./manage.py migrate
      - run:
          name: execute django unittest
          command: sleep 5
          # command: docker-compose run haw ./manage.py test
      - run:
          name: execute django flake8
          command: sleep 5
          # command: docker-compose run haw flake8 ./
      - run:
          name: docker-compose down
          command: sleep 5
          # command: docker-compose down

  deploy:
    machine:
      image: circleci/classic:edge
    steps:
      - run:
          name: execute ansible playbook
          command: sleep 5
      - run:
          name: aws certification
          command: sllep 5
      - run:
          name: execute deploy
          command: ssh ${USER_NAME}@${HOST_NAME} 'pwd && ls -sla'

workflows:
  version: 2
  buiid-and-deploy:
    jobs:
      - build
      - deploy:
        # The deployment job is executed after the completion of the execution of the build job.
        # If requires is not specified, build and deploy jobs are executed in parallel.
          requires:
            - build
          filters:
            # You can set the timing to execute CIrcleCI for each branch.
            branches:
              # TODO: 検証用に作業ブランチを指定しているが、完成時にmasterに置き換える
              only: feature/HAW-42
