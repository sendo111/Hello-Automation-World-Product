version: 2.1
jobs:
  build:
    machine:
      # Ubuntu v14.04
      # https://circleci.com/docs/ja/2.0/configuration-reference/
      image: circleci/classic:edge
    steps:
      - run:
          name: docker-compose up
          command: docker-compose ip -d
      - run:
          name: sleep 10 seconds
          command: sleep 10
      - run:
          name: execute django makemigrations
          command: docker-compose run haw ./manage.py makemigrations
      - run:
          name: execute django migrate
          command: docker-compose run haw ./manage.py migrate
      - run:
          name: execute django unittest
          command: docker-compose run haw ./manage.py test
      - run:
          name: execute django flake8
          command: docker-compose run haw flake8 ./
      - run:
          name: docker-compose down
          command: docker-compose down

  deploy:
    machine:
      image: circleci/classic:edge
    steps:
      - run:
          name: execute ansible playbook
          command:
      - run:
          name: aws certification
          command:
      - run:
        name: execute deploy
        command:

workflows:
  version: 2
  buiid-and-deploy:
    jobs:
      - build
      - deploy:
        # The deployment job is executed after the completion of the execution of the build job.
        # If requires is not specified, build and deploy jobs are executed in parallel.
        requires:
          - build
        filters:
          # You can set the timing to execute CIrcleCI for each branch.
          branches:
            # TODO: 検証用に作業ブランチを指定しているが、完成時にmasterに置き換える
            only: feature/HAW-42
